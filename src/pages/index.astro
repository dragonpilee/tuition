---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Home_Tuition_Palai v1.0">
	<div class="container register">
		<div class="row">
			<div class="col-md-12">
				<h3 class="register-heading">Home_Tuition_Palai v1.0</h3>
				<form id="attendance-form" autocomplete="off">
					<div class="form-group">
						<input type="text" name="Name" class="form-control" placeholder="Your Name *" required />
					</div>

					<div class="form-group">
						<input type="number" name="Number" class="form-control" placeholder="No. of Hours *" required />
					</div>

					<div class="form-group">
						<input type="date" name="Date" id="dateInput" class="form-control" placeholder="DD-MM-YY *" required />
					</div>

					<div class="form-group">
						<button type="submit" id="submitBtn" class="btnSubmit btn-block">Submit</button>
					</div>
				</form>
				<div id="statusMessage" class="mt-3 text-center" style="display: none;"></div>
			</div>
		</div>
	</div>
</Layout>

<script>
	// Dynamic Date and Form Submission
	document.addEventListener("DOMContentLoaded", function() {
		// Set current date
		const dateInput = document.getElementById('dateInput') as HTMLInputElement;
		if (dateInput) {
			const currentDate = new Date().toISOString().split('T')[0];
			dateInput.value = currentDate;
		}

		// Form Submission Logic
		const form = document.getElementById('attendance-form') as HTMLFormElement;
		const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
		const statusMessage = document.getElementById('statusMessage');

		// Replace with your Google Apps Script Web App URL
		const SCRIPT_URL = ''; 

		form?.addEventListener('submit', async (e) => {
			e.preventDefault();
			
			if (!SCRIPT_URL) {
				alert("Please configure the SCRIPT_URL in index.astro");
				return;
			}

			submitBtn.disabled = true;
			submitBtn.innerText = "Submitting...";
			if (statusMessage) {
				statusMessage.style.display = 'block';
				statusMessage.innerText = "Processing...";
				statusMessage.style.color = '#7dfcff';
			}

			const formData = new FormData(form);
			
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: formData
				});

				const result = await response.json();
				
				if (result.result === 'success') {
					if (statusMessage) {
						statusMessage.innerText = "Success! Attendance logged. ðŸš€";
						statusMessage.style.color = "#00ffcc";
					}
					form.reset();
					// Reset date after reset
					if (dateInput) {
						dateInput.value = new Date().toISOString().split('T')[0];
					}
				} else {
					throw new Error(result.error || "Unknown error occurred");
				}
			} catch (error) {
				console.error('Error!', error.message);
				if (statusMessage) {
					statusMessage.innerText = "Error: " + error.message;
					statusMessage.style.color = "#ff00c8";
				}
			} finally {
				submitBtn.disabled = false;
				submitBtn.innerText = "Submit";
			}
		});
	});
</script>
